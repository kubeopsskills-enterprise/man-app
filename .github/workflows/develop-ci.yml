name: Develop CI

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]

env:
  DOTNET_CLI_HOME: "/home/azureuser"
  HOME: "/home/azureuser"

jobs:

  unit-tests:

    name: Run Unit tests

    runs-on: self-hosted:dev

    steps:
    - uses: actions/checkout@v2
    - name: Setup .NET
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: '6.0.x'
    - name: Restore dependencies
      run: dotnet restore
    - name: Build
      run: dotnet build --no-restore
    - name: Test
      run: |
        dotnet test --no-build --verbosity normal > unit-test-results
        cat ./unit-test-results

    - name: Send notification to MS Team channel
      run: |
        curl -H 'Content-Type: application/json' -d '{"text": $(cat unit-test-results)}' ${{ secrets.MS_TEAM_DEV_WEBHOOK }}

  ##################################################################################################

  # codeql:

  #   name: Scan the code with CodeQL

  #   runs-on: self-hosted:dev

  #   permissions:
  #     actions: read
  #     contents: read
  #     security-events: write

  #   services:
  #     postgres:
  #       image: postgres
  #       env:
  #         POSTGRES_PASSWORD: postgres
  #       options: >-
  #         --health-cmd pg_isready
  #         --health-interval 10s
  #         --health-timeout 5s
  #         --health-retries 5
  #       ports:
  #         - 5432:5432

  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       language: [ 'csharp', 'javascript' ]

  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v2
  #       with:
  #           ref: develop

  #     - name: Initialize CodeQL
  #       uses: github/codeql-action/init@v1
  #       with:
  #         languages: ${{ matrix.language }}

  #     - name: Autobuild
  #       uses: github/codeql-action/autobuild@v1

  #     - name: Perform CodeQL Analysis
  #       uses: github/codeql-action/analyze@v1

  #################################################################################################



  dispatch-repository:
    if: github.event_name == 'push'
    name: Dispatch repository

    runs-on: self-hosted:dev

    # needs: [unit-tests, codeql]
    needs: [unit-tests]

    steps:
      - run: |
          echo "SHA -> ${GITHUB_SHA}" 
          echo "SHA -> " ${GITHUB_SHA}
          cat ./.github/template/env-repository-dispatch.json
          echo "\n"
          DISPATCH_SHA=$(echo ${GITHUB_SHA})
          echo $DISPATCH_SHA
          echo $(jq '.event_type |= "dev-ais-app-repository-dispatch" | .client_payload.github_sha |= "'$DISPATCH_SHA'"' ./.github/template/env-repository-dispatch.json)
      # - name: Repository dispatch
      #   run: |
      #     curl -v --location --request POST 'https://api.github.com/repos/kubeopsskills-enterprise/man-app/dispatches' \
      #       --header 'Authorization: Bearer ${{ secrets.DISPATCHER_TOKEN }}' \
      #       --header 'accept: application/vnd.github.v3+json' \
      #       --header 'Content-Type: application/json' \
      #       --data-raw '{"event_type":"dev-ais-app-repository-dispatch", "client_payload": {"github_sha": "${ echo "XXXX" }"}}'

